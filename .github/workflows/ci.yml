name: DevSecOps (Pylint, Bandit, Safety)

# Quand le workflow se déclenche
on:
  push:              # À chaque push
    branches:
      - main         # Sur la branche main
      - develop      # Et develop (ajoute tes branches)
  pull_request:      # Et sur les pull requests

jobs:
  security-checks:
    runs-on: ubuntu-latest   # Machine Linux virtuelle

    steps:
      # 1) Récupère ton code depuis GitHub
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Installe Python (choisis ta version)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"   # Change si besoin (3.11, 3.10...)

      # 3) Met à jour pip (gestionnaire de paquets Python)
      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # 4) IMPORTANT: Installe les dépendances de TON projet
      #    Sinon Pylint va sortir des E0401 (Unable to import)
      - name: Install project dependencies
        run: |
          # Si tu as un requirements.txt
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          # Sinon installe au minimum pywebview (adapte selon ton projet)
          pip install pywebview

      # 5) Installe les outils DevSecOps
      - name: Install security tools
        run: pip install pylint bandit safety

      # 6) Lance Pylint (qualité du code)
      - name: Run Pylint
        run: |
          echo "=== PYLINT: Analyse de la qualité du code ==="
          # --fail-under=7 = note minimale 7/10 pour passer (ajuste si besoin)
          # scripts/ = dossier à scanner (change selon ton projet)
          pylint scripts/ --fail-under=7.0
        continue-on-error: false   # Arrête si ça échoue

      # 7) Lance Bandit (sécurité du code Python)
      - name: Run Bandit
        run: |
          echo "=== BANDIT: Scan de sécurité du code ==="
          # -r = récursif (scanne tous les sous-dossiers)
          # -ll = level LOW (montre seulement Medium et High)
          # -f json = format JSON (optionnel, garde "text" pour lisible)
          bandit -r scripts/ -ll
        continue-on-error: false

      # 8) Lance Safety (vulnérabilités des dépendances)
      - name: Run Safety
        run: |
          echo "=== SAFETY: Scan des dépendances ==="
          # safety scan = commande de base (nouvelle CLI)
          safety scan
        continue-on-error: true   # Continue même si des vulnérabilités (warn only)
